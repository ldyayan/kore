/* ************************************************************************
*   File: magic.c                                       Part of CircleMUD *
*  Usage: low-level functions for magic; spell template code              *
*                                                                         *
*  All rights reserved.  See license.doc for complete information.        *
*                                                                         *
*  Copyright (C) 1993, 94 by the Trustees of the Johns Hopkins University *
*  CircleMUD is based on DikuMUD, Copyright (C) 1990, 1991.               *
************************************************************************ */


#include "conf.h"
#include "sysdep.h"
#include "structs.h"
#include "utils.h"
#include "comm.h"
#include "spells.h"
#include "handler.h"
#include "db.h"
#include "interpreter.h"

extern struct room_data *world;
extern struct obj_data *object_list;
extern struct char_data *character_list;
extern struct str_app_type str_app[];
extern struct int_app_type int_app[];
extern struct index_data *obj_index;
struct index_data *mob_index; 

extern struct weather_data weather_info;
extern struct descriptor_data *descriptor_list;
extern struct zone_data *zone_table;

extern int mini_mud;
extern int pk_allowed;


extern struct default_mobile_stats *mob_defaults;
extern char weapon_verbs[];
extern int *max_ac_applys;
extern struct apply_mod_defaults *apmd;

void clearMemory(struct char_data * ch);
void act(char *str, int i, struct char_data * c, struct obj_data * o,
	      void *vict_obj, int j);

void damage(struct char_data * ch, struct char_data * victim,
	         int damage, int weapontype);

void weight_change_object(struct obj_data * obj, int weight);
void add_follower(struct char_data * ch, struct char_data * leader);
int dice(int number, int size);
extern struct spell_info_type spell_info[];
/* NeXTs need getpid defined for some reason */
int getpid(void);	/* /NextDeveloper/Headers/bsd/libc.h */
int number_range(int from, int to);


struct char_data *read_mobile(int, int);


/*
 * Saving throws for:
 * MCTW
 *   PARA, ROD, PETRI, BREATH, SPELL
 *     Levels 0-60
 */

const byte saving_throws[NUM_CLASSES][NUM_SAVING_THROW_TYPES][LVL_IMPL+1] = {
  {						/* MAGIC-USER */
    						/* PARA */
    {90, 						/* 0 */
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,		/* 1 - 10 */
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,		/* 11 - 20 */
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,		/* 21 - 30 */
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,		/* 31 - 40 */
     30, 29, 28, 27, 27, 27, 27, 26, 26, 26,		/* 41 - 50 */
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},		/* 51 - 60 */
						/* ROD */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* BREATH */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* PETRI */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* SPELL */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
  },

  {						/* CLERIC */
						/* PARA */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* ROD */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* PETRI */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* BREATH */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* SPELL */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
  },

  {						/* THIEF */
						/* PARA */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* ROD */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* PETRI */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* BREATH */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* SPELL */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
  },

  {						/* WARRIOR */
    {24,
     23, 22, 22, 21, 21, 20, 20, 19, 19, 18,
     18, 17, 17, 16, 16, 15, 15, 14, 14, 13,
     13, 12, 12, 11, 11, 11, 10, 10, 10, 10,
     10, 10, 9, 9, 9, 8, 8, 8, 7, 7,
     7, 6, 6, 6, 5, 5, 5, 4, 4, 4,
     3, 3, 3, 3, 3, 3, 3, 3, 3, 3},		
						/* PARA */
    {25,
     24, 23, 23, 22, 22, 21, 21, 20, 20, 19,
     19, 18, 18, 17, 17, 16, 16, 15, 15, 14,
     14, 13, 13, 12, 12, 12, 11, 11, 11, 10,
     10, 10, 9, 9, 9, 8, 8, 8, 7, 7,
     7, 6, 6, 6, 5, 5, 5, 4, 4, 4,
     3, 3, 3, 3, 3, 3, 3, 3, 3, 3},
						/* ROD */
    {25,
     24, 23, 23, 22, 22, 21, 21, 20, 20, 19,
     19, 18, 18, 17, 17, 16, 16, 15, 15, 14,
     14, 13, 13, 12, 12, 12, 11, 11, 11, 10,
     10, 10, 9, 9, 9, 8, 8, 8, 7, 7,
     7, 6, 6, 6, 5, 5, 5, 4, 4, 4,
     3, 3, 3, 3, 3, 3, 3, 3, 3, 3},
						/* PETRI */
    {25,
     24, 23, 23, 22, 22, 21, 21, 20, 20, 19,
     19, 18, 18, 17, 17, 16, 16, 15, 15, 14,
     14, 13, 13, 12, 12, 12, 11, 11, 11, 10,
     10, 10, 9, 9, 9, 8, 8, 8, 7, 7,
     7, 6, 6, 6, 5, 5, 5, 4, 4, 4,
     3, 3, 3, 3, 3, 3, 3, 3, 3, 3},
						/* BREATH */
    {25,
     24, 23, 23, 22, 22, 21, 21, 20, 20, 19,
     19, 18, 18, 17, 17, 16, 16, 15, 15, 14,
     14, 13, 13, 12, 12, 12, 11, 11, 11, 10,
     10, 10, 9, 9, 9, 8, 8, 8, 7, 7,
     7, 6, 6, 6, 5, 5, 5, 4, 4, 4,
     3, 3, 3, 3, 3, 3, 3, 3, 3, 3},
						/* SPELL */
  },

  {						/* BARD */
						/* PARA */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* ROD */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* PETRI */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* BREATH */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* SPELL */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
  },

  {						/* DRAGON */
    						/* PARA */
    {90, 						/* 0 */
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,		/* 1 - 10 */
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,		/* 11 - 20 */
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,		/* 21 - 30 */
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,		/* 31 - 40 */
     30, 29, 28, 27, 27, 27, 27, 26, 26, 26,		/* 41 - 50 */
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},		/* 51 - 60 */
						/* ROD */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* BREATH */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* PETRI */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* SPELL */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
  },

  {						/* DRUID */
						/* PARA */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* ROD */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* PETRI */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* BREATH */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* SPELL */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
  },

  {						/* UNUSED7 */
						/* PARA */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* ROD */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* PETRI */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* BREATH */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* SPELL */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
  },

  {						/* UNUSED8 */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* ROD */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* PETRI */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* BREATH */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* SPELL */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
  },

  {						/* UNUSED9 */
						/* PARA */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* ROD */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* PETRI */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* BREATH */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* SPELL */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
  },

  {						/* VAMPIRE */
    						/* PARA */
    {90, 						/* 0 */
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,		/* 1 - 10 */
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,		/* 11 - 20 */
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,		/* 21 - 30 */
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,		/* 31 - 40 */
     30, 29, 28, 27, 27, 27, 27, 26, 26, 26,		/* 41 - 50 */
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},		/* 51 - 60 */
						/* ROD */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* BREATH */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* PETRI */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* SPELL */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
  },

  {						/* LICH */
						/* PARA */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* ROD */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* PETRI */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* BREATH */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* SPELL */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
  },

  {						/* GHOUL */
						/* PARA */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* ROD */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* PETRI */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* BREATH */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* SPELL */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
  },

  {						/* UNUSED */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* ROD */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* PETRI */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* BREATH */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* SPELL */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
  },

  {						/* GHOST */
						/* PARA */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* ROD */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* PETRI */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* BREATH */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* SPELL */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
  },

  {						/* ANIMAL */
    						/* PARA */
    {90, 						/* 0 */
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,		/* 1 - 10 */
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,		/* 11 - 20 */
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,		/* 21 - 30 */
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,		/* 31 - 40 */
     30, 29, 28, 27, 27, 27, 27, 26, 26, 26,		/* 41 - 50 */
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},		/* 51 - 60 */
						/* ROD */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* BREATH */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* PETRI */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* SPELL */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
  },

  {						/* CURRENCY */
						/* PARA */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* ROD */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* PETRI */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* BREATH */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* SPELL */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
  },

  {						/* CITY */
						/* PARA */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* ROD */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* PETRI */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* BREATH */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* SPELL */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
  },

  {						/* DEATHKNIGHT */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* ROD */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* PETRI */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* BREATH */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* SPELL */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
  },

  {						/* MUPPET */
						/* PARA */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* ROD */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* PETRI */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* BREATH */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* SPELL */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
  },

  {						/* Monk */
						/* PARA */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* ROD */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* PETRI */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* BREATH */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
						/* SPELL */
    {90,
     90, 89, 87, 86, 84, 83, 81, 80, 78, 77,
     75, 74, 72, 71, 69, 68, 66, 65, 63, 62,
     60, 59, 57, 56, 54, 53, 51, 50, 48, 47,
     45, 44, 42, 41, 39, 38, 36, 35, 33, 32,
     30, 29, 28, 27, 27, 27, 27, 27, 27, 27,
     25, 25, 24, 24, 23, 23, 22, 22, 21, 21},
  }

};



int mag_savingthrow(struct char_data * ch, int type)
{
  int save;

  if (type == SAVING_NO_SAVE)
    return FALSE;

  if (IS_AFFECTED(ch, AFF_MAGIC_RESIST)) {
    if (number(0, 99) < 30) 
      return FALSE;
    else
      return TRUE;
  }
    
  if (IS_NPC(ch)) {
    save = saving_throws[CLASS_WARRIOR][type][(int) GET_LEVEL(ch)];
    save += GET_SAVE(ch, type);
  } else {
/*
    save = saving_throws[(int) GET_CLASS(ch)][type][(int) GET_LEVEL(ch)];
*/
    save = 25 + GET_SAVE(ch, type);
  }

  /* throwing a 0 is always a failure */
  if (MAX(1, save) < number(0, 25))
    return TRUE;
  else
    return FALSE;
}


/* affect_update: called from comm.c (causes spells to wear off) */
void affect_update(void)
{
  static struct affected_type *af, *next;
  static struct char_data *i;
  extern char *spell_wear_off_msg[];

  for (i = character_list; i; i = i->next)
    for (af = i->affected; af; af = next) {
      next = af->next;
      if (af->duration >= 1)
	af->duration--;
      else if (af->duration == -1)
	/* No action */
	af->duration = -1;	/* GODs only! unlimited */
      else {
	if ((af->type > 0) && (af->type <= MAX_SPELLS))
	  if (!af->next || (af->next->type != af->type) ||
	      (af->next->duration > 0))
	    if (*spell_wear_off_msg[af->type]) {
	      send_to_char(spell_wear_off_msg[af->type], i);
	      send_to_char("\r\n", i);
	      /* Charmies are free, and pissed */
	      if( (af->bitvector == AFF_CHARM) && i->master &&
				i->in_room == i->master->in_room ) {
		hit(i, i->master, TYPE_UNDEFINED);
		affect_remove(i, af);
		continue;
	      }
	    }
	affect_remove(i, af);

      }
    }
}


/*
  mag_materials:
  Checks for up to 3 vnums in the player's inventory.
*/

int mag_materials(struct char_data * ch, int item0, int item1, int item2,
		      int extract, int verbose)
{
  struct obj_data *tobj;
  struct obj_data *obj0, *obj1, *obj2;

  for (tobj = ch->carrying; tobj; tobj = tobj->next) {
    if ((item0 > 0) && (GET_OBJ_VNUM(tobj) == item0)) {
      obj0 = tobj;
      item0 = -1;
    } else if ((item1 > 0) && (GET_OBJ_VNUM(tobj) == item1)) {
      obj1 = tobj;
      item1 = -1;
    } else if ((item2 > 0) && (GET_OBJ_VNUM(tobj) == item2)) {
      obj2 = tobj;
      item2 = -1;
    }
  }
  if ((item0 > 0) || (item1 > 0) || (item2 > 0)) {
    if (verbose) {
      switch (number(0, 2)) {
      case 0:
	send_to_char("A wart sprouts on your nose.\r\n", ch);
	break;
      case 1:
	send_to_char("Your hair falls out in clumps.\r\n", ch);
	break;
      case 2:
	send_to_char("A huge corn develops on your big toe.\r\n", ch);
	break;
      }
    }
    return (FALSE);
  }
  if (extract) {
    if (item0 < 0) {
      obj_from_char(obj0);
      extract_obj(obj0);
    }
    if (item1 < 0) {
      obj_from_char(obj1);
      extract_obj(obj1);
    }
    if (item2 < 0) {
      obj_from_char(obj2);
      extract_obj(obj2);
    }
  }
  if (verbose) {
    send_to_char("A puff of smoke rises from your pack.\r\n", ch);
    act("A puff of smoke rises from $n's pack.", TRUE, ch, NULL, NULL, TO_ROOM);
  }
  return (TRUE);
}




/*
 * Every spell that does damage comes through here.  This calculates the
 * amount of damage, adds in any modifiers, determines what the saves are,
 * tests for save and calls damage();
 */
void mag_damage(int level, struct char_data * ch, struct char_data * victim,
		     int spellnum, int savetype)
{
  int is_mage = 0, is_cleric = 0;
  int dam = 0;
  struct obj_data *wielded;


  if (victim == NULL || ch == NULL)
    return;

  switch (GET_CLASS(ch)) {
    case CLASS_MAGIC_USER:
/* tmp
    case CLASS_DRAGON:
*/
    case CLASS_VAMPIRE:
      is_mage = 1;
      break;
    default:
      break;
  }

  switch (GET_CLASS(ch)) {
    case CLASS_CLERIC:
/*
    case CLASS_LICH:
*/
      is_cleric = 1;
      break;
    default:
      break;
  }

  switch (spellnum) {

  case SPELL_ACID_BLAST:
    dam = dice(GET_LEVEL(ch), 10) + 50;
    break;

  case SPELL_BURNING_HANDS:
    if (is_mage)
      dam = dice(2, 6) + 6;
    else
      dam = dice(2, 6) + 3;
    break;

  case SPELL_CALL_LIGHTNING:
    dam = dice(8, 10) + 35;
    break;

  case SPELL_CAUSE_LIGHT:
    dam = dice(1, 8) + 4;
    break;

  case SPELL_CAUSE_SERIOUS:
    dam = dice(3, 8) + 2;
    break;

  case SPELL_CAUSE_CRITIC:
    dam = dice(5, 10) + 4;
    break;
 
  case SPELL_CHILL_TOUCH:       /* chill touch also has an affect */
    if (is_mage)
      dam = dice(5, 5) + 154;
    else
      dam = dice(1, 6) + 10;
    break;

  case SPELL_CLOUDKILL:		/* cloudkills main affect is to poison */
    if (is_mage)
      dam = dice(2, 8) + 58;
    else
      dam = dice(2, 6) + 4;
    break;

  case SPELL_COLOR_SPRAY:
    if (is_mage)
      dam = dice(GET_LEVEL(ch), 6) + 50;
/*
      dam = dice(5, 6) + 300;
*/
    else
      dam = dice(6, 6) + 9;
    break;

  case SPELL_CONE_OF_COLD:
    if (is_mage)
      dam = dice(4, 3) + 355;
    else
      dam = dice(4, 6) + 50;
    break;

  case SPELL_DISINTEGRATE:
    if (is_mage)
      dam = dice(10, 6) + 475;
    else
      dam = dice(4, 6) + 60;
    break;

  case SPELL_DISPEL_EVIL:
/*
    dam = dice(6, 8) + 90;
*/
    dam = dice(10, GET_LEVEL(ch)) + 4*GET_LEVEL(ch);
    if (IS_NEUTRAL(ch)) {
	send_to_char("You have no clear distinction between good and evil.\r\n", ch);
	return;
    }
    if (!IS_GOOD(ch)) {
      victim = ch;
      dam = GET_HIT(ch) - 1;
    } else if (!IS_EVIL(victim)) {
      act("Karn protects $N.", FALSE, ch, 0, victim, TO_CHAR);
      dam = 0;
      return;
    }
    break;

  case SPELL_DISPEL_GOOD:
/*
    dam = dice(6, 8) + 90;
*/
    dam = dice(10, GET_LEVEL(ch)) + 4*GET_LEVEL(ch);
    if (IS_NEUTRAL(ch)) {
	send_to_char("You have no clear distinction between good and evil.\r\n", ch);
	return;
    }
    if (!IS_EVIL(ch)) {
      victim = ch;
      dam = GET_HIT(ch) - 1;
    } else if (!IS_GOOD(victim)) {
      act("Zirnozz protect $N.", FALSE, ch, 0, victim, TO_CHAR);
      dam = 0;
      return;
    }
    break;

  case SPELL_EARTHQUAKE:
    if (IS_AFFECTED(victim, AFF_FLY)) {
      act("$n's feet aren't even on the ground!.", TRUE, victim, 0, 0, TO_ROOM);
      dam = 0;
      return;
    } else {
      dam = dice(4, 8) + (level*2);
    }
    break;

  case SPELL_ENERGY_DRAIN:
    if (GET_LEVEL(victim) <= 2)
      dam = 100;
      else
      dam = dice(7, 6);
    break;

  case SPELL_FIREBALL:
    dam = number_range(50, 250);

  case SPELL_FIRESTORM:
    if (GET_CLASS(ch) == CLASS_DRUID)
      dam = number_range(150, 400);
    else
      dam = dice(6, 20);
    break;

  case SPELL_ICE_STORM:
    dam = number_range(50, 250);
    break;

  case SPELL_SUNRAY:
    if (GET_RACE(victim) == RACE_UNDEAD)
      dam = number_range(300, 750);
    else
      dam = 0;
    break;

  case SPELL_FIST_OF_EARTH:
    if (GET_CLASS(ch) == CLASS_DRUID)
      dam = dice(7, 5) + 250;
    else
      dam = dice(5, 6) + 100;
    break;

  case SPELL_FIST_OF_STONE:
    if (GET_CLASS(ch) == CLASS_DRUID)
      dam = dice(7, 7) + 350;
    else
      dam = dice(5, 6) + 100;
    break;

  case SPELL_HARM:
    dam = dice(10, 10) + 120;
    break;

  case SPELL_LIGHTNING_BOLT:
  case SPELL_CHAIN_LIGHTNING:
    if (is_mage)
      dam = number_range(200, 400);
    else
      dam = dice(5, 6) + 107;
    break;

  case SPELL_MAGIC_MISSILE:
    if (is_mage)
      dam = dice(1, 20) + 10;
    else
      dam = dice(1, 4) + 1;
    break;

  case SPELL_NUKE:
    dam = dice(3000, 1) + level;
    break;

  case SPELL_PETRIFY:
    if (is_cleric)
      dam = number_range(200, 500);
    else
      dam = dice(5, 5) + 200;

  case SPELL_SEARING_ORB:
    if (is_mage)
      dam = dice(4, 6) + 105;
    else
      dam = dice(3, 6) + 105;
    break;

  case SPELL_SHOCKING_GRASP:
    if (is_mage)
      dam = dice(4, 6) + 105;
    else
      dam = dice(3, 6) + 105;
    break;

  case SPELL_WORD_OF_DEATH:
  case SPELL_AREA_WORD_OF_DEATH:
/*
    dam = dice(30, 15) + 300;
*/
    dam = dice(GET_LEVEL(ch), 10) + 250;
    break;

  case SKILL_BERSERK:
    /* crude guess at damage, not counting position and other stuff */
    spellnum = TYPE_HIT;
    dam = str_app[STRENGTH_APPLY_INDEX(ch)].todam;
    dam += GET_DAMROLL(ch);
    wielded = ch->equipment[GET_WEAR_WIELD(ch)]; 
    if (wielded) {
      dam += dice(GET_OBJ_VAL(wielded, 1), GET_OBJ_VAL(wielded, 2));
      spellnum += GET_OBJ_VAL(wielded, 3);
    }
    if (IS_NPC(ch))
      dam += dice(ch->mob_specials.damnodice,ch->mob_specials.damsizedice);
    else
      dam += number(0, 2);
    break;
  }				/* switch(spellnum) */

  if (mag_savingthrow(victim, savetype))
    dam >>= 1;

  damage(ch, victim, dam, spellnum);
}


/*
  Every spell that does an affect comes through here.  This determines
  the effect, whether it is added or replacement, whether it is legal or
  not, etc.

  affect_join(vict, aff, add_dur, avg_dur, add_mod, avg_mod)
*/

void mag_affects(int level, struct char_data * ch, struct char_data * victim,
		      int spellnum, int savetype)
{

  struct affected_type af;

  if (victim == NULL || ch == NULL)
    return;

  af.bitvector = 0;
  af.bitvector2 = 0;

  af.modifier = 0;
  af.location = APPLY_NONE;

  if (IS_AFFECTED(victim, AFF_MAGIC_RESIST))
    act("$N's magic shell will protect $M...", FALSE, ch, 0, victim, TO_CHAR);

  switch (spellnum) {

  case SPELL_AID:
    act("$n receives aid.", TRUE, victim, 0, 0, TO_ROOM);
    af.type = SPELL_AID;
    af.duration = GET_LEVEL(ch) / 10 + 2;
    af.modifier = 2;
    af.location = APPLY_DAMROLL;
    af.bitvector = AFF_AID;
    af.bitvector2 = 0;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    af.type = SPELL_AID_2;  /* Here's that hack again :) */
    af.modifier = 15;
    af.location = APPLY_HIT;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    send_to_char("You receive aid.\r\n", victim);
    break;

  case SPELL_INSPIRE:
  case SPELL_BATTLE_HYMN:
    if (IS_AFFECTED(victim, AFF_INSPIRE)) {
      act("Nothing seems to happen.", TRUE, victim, 0, 0, TO_ROOM);
      return;
    }

    act("$n looks inspired!", TRUE, victim, 0, 0, TO_ROOM);

    af.type = SPELL_INSPIRE;
    af.duration = GET_LEVEL(ch) / 10 + 2;
    af.location = APPLY_HITROLL;
    af.modifier = (GET_LEVEL(ch) / 10) + number(2, 5);
    af.type = SPELL_INSPIRE_2;
    af.location = APPLY_DAMROLL;
    af.bitvector = AFF_INSPIRE;
    af.bitvector2 = 0;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    send_to_char("You feel inspired!\r\n", victim);
    break;

  case SPELL_MANASHELL:
    if (IS_AFFECTED2(ch, AFF2_MANASHELL)) {
        send_to_char("You are already protected by mana.\r\n", victim);
	return;
    }

    act("$n is surrounded by a field of magical force.", TRUE, victim, 0, 0, TO_ROOM);

    af.type = SPELL_MANASHELL;
    af.duration = 6;
    af.bitvector = 0;
    af.bitvector2 = AFF2_MANASHELL;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    send_to_char("You are surrounded by a field of magical force.\r\n", victim);
    break;


  /*
   * the code that sets the number of images on a mob when it is loaded
   * is in db.c in the read_mobile() function
   */
  case SPELL_MIRROR_IMAGE:
    if (IS_AFFECTED(ch, AFF_MIRROR_IMAGE)) {
	if (GET_IMAGES(ch) <= 0) {
	    affect_from_char(ch, SPELL_MIRROR_IMAGE);
	} else {
	    send_to_char("You are already mirrored.\n\r", ch);
	    return;
	}
    }
    GET_IMAGES(ch) = (GET_LEVEL(ch) / 10) + number(2, 5);
    act("$n is surrounded by images!", TRUE, ch, 0, 0, TO_ROOM);
    sprintf(buf, "You are surrounded by %d images!", GET_IMAGES(ch));
    act(buf, TRUE, ch, 0, 0, TO_CHAR);
    af.type = SPELL_MIRROR_IMAGE;
    af.duration = 2 + (GET_LEVEL(ch) / 10);
    af.bitvector = AFF_MIRROR_IMAGE;
    af.bitvector2 = 0;
    affect_join(ch, &af, TRUE, FALSE, FALSE, FALSE);
    break;

  case SPELL_ANTIMAGIC_SHELL:
    /* so you can't remove magic resistance from resistant mobs.. */
    if (IS_NPC(victim) && IS_AFFECTED(victim, AFF_MAGIC_RESIST)) {
      act("Nothing seems to happen.", TRUE, victim, 0, 0, TO_ROOM);
      return;
    }
    act("$n is surrounded by a magic shell.", TRUE, victim, 0, 0, TO_ROOM);
    act("You see a magic shell surround and protect you.", 
	TRUE, victim, 0, 0, TO_CHAR);
    af.type = SPELL_ANTIMAGIC_SHELL;
    af.duration = GET_LEVEL(ch) / 10;
    af.bitvector = AFF_MAGIC_RESIST;
    af.bitvector2 = 0;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    break;

  case SPELL_ARMOR:
    af.type = SPELL_ARMOR;
    af.duration = GET_LEVEL(ch) / 10 + 5;
    af.modifier = -((GET_LEVEL(ch)/5)+20);
    af.location = APPLY_AC;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    send_to_char("You feel someone protecting you.\r\n", victim);
    break;

  case SPELL_BARKSKIN:
    af.type = SPELL_BARKSKIN;
    af.duration = GET_LEVEL(ch) / 10 + 5;
    af.modifier = -((GET_LEVEL(ch)/5)+20);
    af.location = APPLY_AC;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    send_to_char("Your skin becomes thick and hardens.\r\n", victim);
    break;

  case SPELL_BLESS:
    act("$n looks righteous!", TRUE, victim, 0, 0, TO_ROOM);
    af.type = SPELL_BLESS;
    af.duration = GET_LEVEL(ch) / 10 + 2;
    af.location = APPLY_HITROLL;
    af.modifier = (GET_LEVEL(ch) / 10) + number(2, 5);
    af.bitvector = AFF_BLESS;
    af.bitvector2 = 0;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    send_to_char("You feel righteous.\r\n", victim);
    break;

  case SPELL_BLINDNESS:
    if (IS_AFFECTED(victim, AFF_BLIND)) {
      send_to_char("Nothing seems to happen.\r\n", ch);
      return;
    }
    if (MOB_FLAGGED(victim, MOB_NOBLIND) || IS_THRIKREEN(victim)) {
      send_to_char("They are immune to blindness!\r\n", ch);
      return;
    }
    if (mag_savingthrow(victim, savetype)) {
      send_to_char("You fail.\r\n", ch);
      return;
    }
    act("$n seems to be blinded!", TRUE, victim, 0, 0, TO_ROOM);
    send_to_char("You have been blinded!\r\n", victim);

    af.type = SPELL_BLINDNESS;
    af.location = APPLY_HITROLL;
    af.modifier = -4;
    af.duration = GET_LEVEL(ch)/6;
    af.bitvector = AFF_BLIND;
    af.bitvector2 = 0;
    affect_join(victim, &af, FALSE, FALSE, FALSE, FALSE);

    af.location = APPLY_AC;
    af.modifier = 40;
    affect_join(victim, &af, FALSE, FALSE, FALSE, FALSE);
    break;

  case SPELL_BLUR:

    act("$n begins moving more quickly.", TRUE, victim, 0, 0, TO_ROOM);
    send_to_char("You feel quicker!\r\n", victim);
    af.type = SPELL_BLUR;
    af.duration = GET_LEVEL(ch) / 10 + 7;
    af.modifier = GET_LEVEL(ch)/8;
    af.location = APPLY_DEX;
    affect_join(victim, &af, TRUE, TRUE, TRUE, FALSE);
    break;

  case SPELL_CHILL_TOUCH:
    if (mag_savingthrow(victim, savetype))
      af.duration = 1;
    else
      af.duration = 2;
    af.type = SPELL_CHILL_TOUCH;
    af.modifier = -1;
    af.location = APPLY_STR;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    send_to_char("You feel your strength wither!\r\n", victim);
    break;

  case SPELL_CURSE:
    if (mag_savingthrow(victim, savetype))
      return;
    af.type = SPELL_CURSE;
    af.duration = GET_LEVEL(ch)/2;
    af.modifier = GET_LEVEL(ch)/6;
    af.location = APPLY_SAVING_SPELL;
    af.bitvector = AFF_CURSE;
    af.bitvector2 = 0;
    affect_join(victim, &af, TRUE, FALSE, TRUE, TRUE);
    act("$n briefly glows red!", FALSE, victim, 0, 0, TO_ROOM);
    act("You feel very uncomfortable.", FALSE, victim, 0, 0, TO_CHAR);
    break;

   case SPELL_DETECT_ALIGN:

    af.type = SPELL_DETECT_ALIGN; 
    af.duration = GET_LEVEL(ch) / 5 + 3;
    af.bitvector = AFF_BLIND;
    af.bitvector2 = 0;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    send_to_char("Your eyes tingle.\r\n", victim);
    break;

  case SPELL_DETECT_INVIS:

    if (IS_AFFECTED(victim, AFF_DETECT_INVIS)) {
      act("Nothing seems to happen.", TRUE, victim, 0, 0, TO_ROOM);
      return;
    }

    af.type = SPELL_DETECT_INVIS;
    af.duration = 4 + GET_LEVEL(ch);
    af.bitvector = AFF_DETECT_INVIS;
    af.bitvector2 = 0;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    send_to_char("Your eyes tingle.\r\n", victim);
    break;

  case SPELL_DETECT_MAGIC:
    af.type = SPELL_DETECT_MAGIC;
    af.duration = 10;
    af.bitvector = AFF_DETECT_MAGIC;
    af.bitvector2 = 0;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    send_to_char("Your eyes tingle.\r\n", victim);
    break;

  case SPELL_DETECT_POISON:
    if (victim == ch)
      if (IS_AFFECTED(victim, AFF_POISON))
	send_to_char("You can sense poison in your blood.\r\n", ch);
      else
	send_to_char("You feel healthy.\r\n", ch);
    else if (IS_AFFECTED(victim, AFF_POISON))
      act("You sense that $E is poisoned.", FALSE, ch, 0, victim, TO_CHAR);
    else
      act("You sense that $E is healthy.", FALSE, ch, 0, victim, TO_CHAR);
    break;

/* WHY IS THIS HERE?
  case SPELL_FEEBLEMIND:
    if (mag_savingthrow(victim, savetype))
      af.duration = 2;
    else
      af.duration = GET_LEVEL(ch)/8;
    af.type = SPELL_FEEBLEMIND;
    af.modifier = GET_LEVEL(ch)/3;
    af.location = APPLY_INT;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    send_to_char("You feel your mind get dimmer!\r\n", victim);
    break;
*/

  case SPELL_FAERIE_FIRE:

    act("$n is surrounded by a pink aura.", TRUE, victim, 0, 0, TO_ROOM);

    af.type = SPELL_FAERIE_FIRE;
    af.duration = GET_LEVEL(ch)/2+7;
    af.modifier = GET_LEVEL(ch)/4+20;
    af.location = APPLY_AC;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    send_to_char("You are surrounded by a pink aura.\r\n", victim);
    break;

  case SPELL_FEEBLEMIND:
    if (mag_savingthrow(victim, savetype))
      af.duration = 2;
    else
      af.duration = GET_LEVEL(ch)/6;
    af.type = SPELL_FEEBLEMIND;
    af.modifier = -(GET_LEVEL(ch)/3);
    af.location = APPLY_INT;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    send_to_char("You feel your mind get dimmer!\r\n", victim);
    break;

  case SPELL_FIRESHIELD:
    if (IS_AFFECTED2(ch, AFF2_FIRESHIELD)) {
        send_to_char("You are already surrounded by flame.\r\n", victim);
	return;
    }

    act("$n is surrounded by a shield of flames.", TRUE, victim, 0, 0, TO_ROOM);

    af.type = SPELL_FIRESHIELD;
    af.duration = number_range(2, 4);
    af.bitvector = 0;
    af.bitvector2 = AFF2_FIRESHIELD;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    send_to_char("You are surrounded by glowing flame.\r\n", victim);
    break;

  case SPELL_FLOATING_DISC:
    if (!victim)
      victim = ch;
    af.type = SPELL_FLOATING_DISC;
    af.duration = 3 + GET_LEVEL(ch) / 5;
    af.modifier = -120;
    af.location = APPLY_CHAR_WEIGHT;
    affect_join(victim, &af, TRUE, FALSE, TRUE, FALSE);
    act("A floating disc appears to ease $n's burdens.",
      TRUE, victim, 0, 0, TO_ROOM);
    break;

  case SPELL_FLY:

    if (IS_AFFECTED(victim, AFF_FLY)) {
      send_to_room("Nothing happens.\r\n", ch->in_room);
      return;
    }
    act("$n's feet rise off the ground.", TRUE, victim, 0, 0, TO_ROOM);

    af.type = SPELL_FLY;
    af.duration = 2 + GET_LEVEL(ch) / 10;
    af.bitvector = AFF_FLY;
    af.bitvector2 = 0;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    send_to_char("You start flying!\r\n", victim);
    break;

  case SPELL_HASTE:
    if (IS_AFFECTED(victim, AFF_HASTE)) {
	act("$N is already moving as fast as $E can.", FALSE, ch, 0, victim, TO_CHAR);
	return;
    }

    act("$n is moving more quickly.", TRUE, victim, 0, 0, TO_ROOM);

    af.type = SPELL_HASTE;
    af.duration = GET_LEVEL(ch)/6;
    af.bitvector = AFF_HASTE;
    af.bitvector2 = 0;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    send_to_char("You feel yourself moving more quickly!\r\n", victim);
    break;

  case SPELL_ICE_SHIELD:
    /* so you can't remove ice shield from ice shieled mobs.. */
    if (IS_AFFECTED2(victim, AFF2_ICE_SHIELD)) {
      act("Already affected by Ice Shield.", TRUE, victim, 0, 0, TO_ROOM);
      return;
    }
    act("$n is surrounded by a frosty Ice Shield.", TRUE, victim, 0, 0, TO_ROOM);
    act("You are surrounded by a shimmering Ice Shield.", TRUE, victim, 0, 0, TO_CHAR);
    af.type = SPELL_ICE_SHIELD;
    af.duration = GET_LEVEL(ch);
    af.bitvector = 0;
    af.bitvector2 = AFF2_ICE_SHIELD; 
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    break;

  case SPELL_INFRAVISION:
    if (IS_AFFECTED(victim, AFF_INFRAVISION)) {
      act("Nothing seems to happen.", TRUE, victim, 0, 0, TO_ROOM);
      return;
    }

    act("$n's eyes glow red.", TRUE, victim, 0, 0, TO_ROOM);

    af.type = SPELL_INFRAVISION;
    af.duration = GET_LEVEL(ch)/5;
    af.bitvector = AFF_INFRAVISION;
    af.bitvector2 = 0;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    send_to_char("Your eyes glow red.\r\n", victim);
    act("$n's eyes glow red.", TRUE, victim, 0, 0, TO_ROOM);
    break;

  case SPELL_INVISIBLE:
    if (!victim)
      victim = ch;
    act("$n slowly fades out of existence.", TRUE, victim, 0, 0, TO_NOTVICT);
    send_to_char("You vanish.\r\n", victim);

    af.type = SPELL_INVISIBLE;
    af.duration = GET_LEVEL(ch)/2;
    af.modifier = -40;
    af.location = APPLY_AC;
    af.bitvector = AFF_INVISIBLE;
    af.bitvector2 = 0;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    break;

  case SPELL_PASS_WITHOUT_TRACE:
    /* so you can't remove notrack from notrack mobs.. */
    if (IS_NPC(victim) && IS_AFFECTED(victim, AFF_NOTRACK)) {
      act("Nothing seems to happen.", TRUE, victim, 0, 0, TO_ROOM);
      return;
    }
/*
    act("$n is surrounded by a magic shell.", TRUE, victim, 0, 0, TO_ROOM);
*/
    act("You feel stealthy and lightfooted.",
        TRUE, victim, 0, 0, TO_CHAR);
    af.type = SPELL_PASS_WITHOUT_TRACE;
    af.duration = GET_LEVEL(ch) / 10;
    af.bitvector = AFF_NOTRACK;
    af.bitvector2 = 0;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    break;

  case SPELL_CLOUDKILL:
  case SPELL_POISON:
    if (!mag_savingthrow(victim, savetype)) {
      af.type = SPELL_POISON;
      af.duration = GET_LEVEL(ch)/4;
      af.modifier = -2;
      af.location = APPLY_STR;
      af.bitvector = AFF_POISON;
      af.bitvector2 = 0;

      affect_join(victim, &af, FALSE, FALSE, FALSE, FALSE);
      send_to_char("You feel very sick.\r\n", victim);
      act("$n gets violently ill!", TRUE, victim, 0, 0, TO_ROOM);
    } else {
      if (spellnum == SPELL_POISON) {
        act("Nothing seems to happen.", TRUE, ch, 0, 0, TO_CHAR);
        return;
      } else /* SPELL_CLOUDKILL */ {
        send_to_char("You cough and start to choke.\r\n", victim);
        act("$n coughs and starts to choke.", TRUE, victim, 0, 0, TO_ROOM);
        return;
      }
    }
    break;

  case SPELL_POISON2:
fprintf(stderr, ">> in poison2\n");
    if (!mag_savingthrow(victim, savetype)) {
      af.type = SPELL_POISON2;
      af.duration = GET_LEVEL(ch)/4;
      af.modifier = -2;
      af.location = APPLY_STR;
      af.bitvector = AFF_SANCTUARY;
      af.bitvector2 = 0;
      affect_join(victim, &af, FALSE, FALSE, FALSE, FALSE);
      send_to_char("You feel very sick with poison 2.\r\n", victim);
      act("$n gets violently ill with poison 2!", TRUE, victim, 0, 0, TO_ROOM);
    } else {
      act("Nothing seems to happen.", TRUE, ch, 0, 0, TO_CHAR);
      return;
    }

  case SPELL_POWER_WORD_STUN:
    if (mag_savingthrow(victim, savetype))
      return;
    af.type = SPELL_POWER_WORD_STUN;
    af.duration = 1;
    af.location = APPLY_NONE;
    af.bitvector = AFF_STUN;
    af.bitvector2 = 0;
    affect_join(victim, &af, FALSE, FALSE, FALSE, FALSE);
    if (GET_POS(victim) > POS_STUNNED) {
      act("You are frozen, unable to move!", FALSE, victim, 0, 0, TO_CHAR);
      act("$n is held in place, completely stunned.", TRUE, victim, 0, 0, TO_ROOM);
      GET_POS(victim) = POS_STUNNED;
    }
    break;

  case SPELL_PROT_FROM_EVIL:
    if (GET_ALIGNMENT(victim) < -350) {
      send_to_char("Protect them from themself? How?\r\n", ch);
      break;
    }
    if (IS_NEUTRAL(ch)) {
      send_to_char("You are not good enough to cast that spell!\r\n", ch);
      break;
    }
    af.type = SPELL_PROT_FROM_EVIL;
    af.duration = 2 + GET_LEVEL(ch) / 10;
    af.bitvector = AFF_PROTECT_EVIL;
    af.bitvector2 = 0;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    send_to_char("You feel protected from evil!\r\n", victim);
    break;

  case SPELL_PROTECTION_FROM_GOOD:
    if (GET_ALIGNMENT(victim) > 350) {
      send_to_char("Protect them against themself? How?\r\n", ch);
      break;
    }
    if (IS_NEUTRAL(ch)) {
      send_to_char("You are not evil enough to cast that spell!\r\n", ch);
      break;
    }
    af.type = SPELL_PROTECTION_FROM_GOOD;
    af.duration = 2 + GET_LEVEL(ch) / 10;
    af.bitvector = AFF_PROTECT_GOOD;
    af.bitvector2 = 0;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    send_to_char("You feel protected from good!\r\n", victim);
    break;

  case SPELL_RAY_OF_ENFEEBLEMENT:
    if (mag_savingthrow(victim, savetype))
      af.duration = 2;
    else
      af.duration = GET_LEVEL(ch)/6;
    af.type = SPELL_RAY_OF_ENFEEBLEMENT;
    af.modifier = -(GET_LEVEL(ch)/4);
    af.location = APPLY_STR;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    send_to_char("You feel your mind get dimmer!\r\n", victim);
    break;

  case SPELL_SANCTUARY:
    /* so you can't remove sanct from sancted mobs.. */
    if (IS_AFFECTED(victim, AFF_SANCTUARY)) {
      act("Nothing seems to happen.", TRUE, victim, 0, 0, TO_ROOM);
      return;
    }
    act("$n is surrounded by a white aura.", TRUE, victim, 0, 0, TO_ROOM);
    act("You start glowing.", TRUE, victim, 0, 0, TO_CHAR);
    af.type = SPELL_SANCTUARY;
    af.duration = GET_LEVEL(ch) / 6 + 2;
    af.bitvector = AFF_SANCTUARY;
    af.bitvector2 = 0;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    break;

  case SPELL_SENSE_LIFE:
    if (IS_AFFECTED(victim, AFF_SENSE_LIFE)) {
      act("Nothing seems to happen.", TRUE, victim, 0, 0, TO_ROOM);
      return;
    }
    send_to_char("Your feel your awareness improve.\r\n", ch);
    af.type = SPELL_SENSE_LIFE;
    af.duration = GET_LEVEL(ch) / 10 + 2;
    af.bitvector = AFF_SENSE_LIFE;
    af.bitvector2 = 0;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    break;

  case SPELL_SLEEP:
    if (mag_savingthrow(victim, savetype))
      return;
    if (IS_NPC(victim))
      if (MOB_FLAGGED(victim, MOB_NOSLEEP))
        return;
    af.type = SPELL_SLEEP;
    af.duration = GET_LEVEL(ch) / 10 + 1;
    af.location = APPLY_NONE;
    af.bitvector = AFF_SLEEP;
    af.bitvector2 = 0;
    affect_join(victim, &af, FALSE, FALSE, FALSE, FALSE);
    if (GET_POS(victim) > POS_SLEEPING) {
      act("You feel very sleepy...zzzzzz", FALSE, victim, 0, 0, TO_CHAR);
      act("$n goes to sleep.", TRUE, victim, 0, 0, TO_ROOM);
      GET_POS(victim) = POS_SLEEPING;
    }
    break;

  case SPELL_SLOW:
    if (IS_AFFECTED(victim, AFF_SLOW)) {
	act("$N is already moving slower than normal.", FALSE, ch, 0, victim, TO_CHAR);
	return;
    }

    act("$n is moving more slowly.", TRUE, victim, 0, 0, TO_ROOM);
    af.type = SPELL_SLOW;
    af.duration = GET_LEVEL(ch) / 10 + 1;
    af.bitvector = AFF_SLOW;
    af.bitvector2 = 0;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    send_to_char("You feel very slow!\r\n", victim);
    break;

  /*
   * the code that sets the number of layers on a mob when it is loaded
   * is in db.c in the read_mobile() function
   */
  case SPELL_STONESKIN:
    if (GET_POS(victim) == POS_FIGHTING) {
      send_to_char("Too late, they're already in combat!\r\n", ch);
      return;
    }
    if ((GET_LAYERS(victim) > 0) && (IS_AFFECTED(victim, AFF_STONESKIN))) {
      act("Your skin is as hard as it can get.", TRUE, victim, 0, 0, TO_CHAR);
      return;
    }
    /* Kas's hp-based limit
    GET_LAYERS(victim) = (GET_LEVEL(ch) * 10) + number(20, 100);
    */
    GET_LAYERS(victim) = (GET_LEVEL(ch) / 6) + number(1, 3);
    act("$n's skin turns hard as stone.", TRUE, victim, 0, 0, TO_ROOM);
    act("Your skin becomes as hard as stone.", TRUE, victim, 0, 0, TO_CHAR);
    af.type = SPELL_STONESKIN;
    af.duration = GET_LEVEL(ch)/10;
    af.bitvector = AFF_STONESKIN;
    af.bitvector2 = 0;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    break;

  case SPELL_STRENGTH:
    if (affected_by_spell(victim, SPELL_STRENGTH)) {
      act("Nothing seems to happen.", TRUE, victim, 0, 0, TO_ROOM);
      break;
    }
    act("$n's muscles soar with heightened power.", TRUE, victim, 0, 0, TO_ROOM);
    send_to_char("You feel stronger!\r\n", victim);
    af.type = SPELL_STRENGTH;
    af.duration = GET_LEVEL(ch) / 10 + 7;
    af.modifier = (GET_LEVEL(ch) + 11) / 20;
    af.location = APPLY_STR;
    affect_join(victim, &af, TRUE, TRUE, TRUE, FALSE);
    break;

/* Sunray also does damage */
/*
  case SPELL_SUNRAY:
    if (IS_AFFECTED(victim, AFF_BLIND)) {
      return;
    }
    if (MOB_FLAGGED(victim, MOB_NOBLIND) || IS_THRIKREEN(victim)) {
      send_to_char("They are immune to blindness!\r\n", ch);
      return;
    }
    act("$n is blinded by the brilliance!", TRUE, victim, 0, 0, TO_ROOM);
    send_to_char("You have are blinded by the brilliant sun!\r\n", victim);

    af.type = SPELL_SUNRAY;
    af.location = APPLY_HITROLL;
    af.modifier = -8;
    af.duration = GET_LEVEL(ch)/6;
    af.bitvector = AFF_BLIND;
    af.bitvector2 = 0;
    affect_join(victim, &af, FALSE, FALSE, FALSE, FALSE);

    af.location = APPLY_AC;
    af.modifier = 40;
    affect_join(victim, &af, FALSE, FALSE, FALSE, FALSE);
    break;
*/

  case SPELL_WATERWALK:
    af.type = SPELL_WATERWALK;
    af.duration = GET_LEVEL(ch) / 10 + 3;
    af.bitvector = AFF_WATERWALK;
    af.bitvector2 = 00;
    affect_join(victim, &af, TRUE, FALSE, FALSE, FALSE);
    send_to_char("You feel webbing between your toes.\r\n", victim);
    break;

  case SPELL_WEB:
    if (mag_savingthrow(victim, savetype))
      return;
    af.type = SPELL_WEB;
    af.duration = GET_LEVEL(ch)/2;
    af.bitvector = 0;
    af.bitvector2 = AFF2_WEBBED;
    affect_join(victim, &af, TRUE, FALSE, TRUE, TRUE);
    act("$n is covered in sticky webs!", FALSE, victim, 0, 0, TO_ROOM);
    act("You are covered in sticky webs.", FALSE, victim, 0, 0, TO_CHAR);
    break;

  }

}



void mag_group_switch(int level, struct char_data * ch, struct char_data * tch,
		           int spellnum, int savetype)
{
  switch (spellnum) {

  case SPELL_DEFENSIVE_HARMONY:
    mag_affects(level, ch, tch, SPELL_ARMOR, savetype);
    break;

  case SPELL_GROUP_HEAL:
    mag_points(level, ch, tch, SPELL_HEAL, savetype);
    break;

  case SPELL_GROUP_RECALL:
    spell_recall(level, ch, tch, NULL, NULL);
/*  Neither of the following work... is it because how WOR is defined?
    mag_groups(level, ch, SPELL_WORD_OF_RECALL, savetype);
    mag_affects(level, ch, tch, SPELL_WORD_OF_RECALL, savetype);
*/
    break;

  case SPELL_GROUP_SANCTUARY:
    mag_affects(level, ch, tch, SPELL_SANCTUARY, savetype);
    break;

  case SPELL_HOLY_LIGHT:
    mag_affects(level, ch, tch, SPELL_AID, savetype);
    break;

  case SPELL_INSTILL_ENERGY:
    mag_affects(level, ch, tch, SPELL_HASTE, savetype);
    break;

  case SPELL_MASS_INVIS:
    mag_affects(level, ch, tch, SPELL_INVISIBLE, savetype);
    break;

  case SPELL_MASS_FLY:
    mag_affects(level, ch, tch, SPELL_FLY, savetype);
    break;

  case SPELL_MASS_REFRESH:
    mag_points(level, ch, tch, SPELL_REFRESH, savetype);
    break;

  case SPELL_PRAYER:
    mag_affects(level, ch, tch, SPELL_BLESS, savetype);
    break;
  }
}

/*
  Every spell that affects the group should run through here
  mag_group_switch contains the switch statement to send us to the right
  magic.

  group spells affect everyone grouped with the caster who is in the room.
*/

void mag_groups(int level, struct char_data * ch, int spellnum, int savetype)
{
  struct char_data *tch, *k;
  struct follow_type *f, *f_next;

  if (ch == NULL)
    return;

  if (!IS_AFFECTED(ch, AFF_GROUP))
    return;

  if (ch->master != NULL)
    k = ch->master;
  else
    k = ch;

  for (f = k->followers; f; f = f_next) {
    f_next = f->next;
    tch = f->follower;
    if (tch->in_room != ch->in_room)
      continue;
    if (!IS_AFFECTED(tch, AFF_GROUP))
      continue;
    mag_group_switch(level, ch, tch, spellnum, savetype);
  }
  if (IS_AFFECTED(k, AFF_GROUP) && (k->in_room == ch->in_room))
    mag_group_switch(level, ch, k, spellnum, savetype);
/*
  if ((k != ch) && IS_AFFECTED(k, AFF_GROUP))
    mag_group_switch(level, ch, k, spellnum, savetype);
  mag_group_switch(level, ch, ch, spellnum, savetype);
*/
}


/*
  mass spells affect every creature in the room except the caster.
*/

void mag_masses(int level, struct char_data * ch, int spellnum, int savetype)
{
  struct char_data *tch, *tch_next;

  for (tch = world[ch->in_room].people; tch; tch = tch_next) {
    tch_next = tch->next_in_room;
    if (tch == ch)
      continue;

    switch (spellnum) {
      case SPELL_BATTLE_HYMN:
          mag_affects(level, ch, tch, SPELL_BATTLE_HYMN, savetype);
          break;
    }
  }
}


/*
  Every spell that affects an area (room) runs through here.  These are
  generally offensive spells.  This calls mag_damage to do the actual
  damage.

  area spells have limited targets within the room.
*/

void mag_areas(byte level, struct char_data * ch, struct char_data * victim,
		int spellnum, int savetype)
{
  struct char_data *tch, *next_tch, *m;
  int skip;

  ACMD(do_bash);
  ACMD(do_trip);


  if ((ch == NULL) || (victim == NULL))
    return;

  if (ch->master != NULL)
    m = ch->master;
  else
    m = ch;

  for (tch = world[victim->in_room].people; tch; tch = next_tch) {
    next_tch = tch->next_in_room;

    /*
     * The skips: 1) immortals && self 2) mobs only hit charmed mobs 3)
     * players can only hit players in CRIMEOK rooms 4) players can only hit
     * charmed mobs in CRIMEOK rooms
     * MOBProg foo: 5) skip mobs that are MOB_NOTTHERE
     * 6) skips players if the caster is a player
     * 7) skips pets
     */

    skip = 0;
    if (IS_NPC(tch) && MOB_FLAGGED(tch, MOB_SAFE))
      skip = 1;
    if (IS_NPC(tch) && MOB_FLAGGED(tch, MOB_NOTTHERE))
      skip = 1;
    if (tch == ch)
      skip = 1;
    if (IS_NPC(ch) && IS_NPC(tch) && !IS_AFFECTED(tch, AFF_CHARM))
      skip = 1;
    if (!IS_NPC(tch) && GET_LEVEL(tch) >= LVL_IMMORT)
      skip = 1;
    if (!IS_NPC(ch) && !IS_NPC(tch))
      skip = 1;
    if (!IS_NPC(ch) && IS_NPC(tch) && IS_AFFECTED(tch, AFF_CHARM))
      skip = 1;
    if (!IS_NPC(ch) && !IS_NPC(tch))
      skip = 1;
    if (IS_PET(tch))
      skip = 1;

    if (skip)
      continue;

    if (victim) {
	if (IS_AFFECTED(victim, AFF_MIRROR_IMAGE)) {
	    affect_from_char(victim, SPELL_MIRROR_IMAGE);
	    GET_IMAGES(victim) = 0; 
	    send_to_char("The last of your images dissipates, leaving you unprotected.\r\n", victim);
	}
    }

    switch (spellnum) {

    case SPELL_AREA_WORD_OF_DEATH:
      mag_damage(GET_LEVEL(ch), ch, tch, spellnum, 1);
      break;

    case SPELL_BURNING_HANDS:
      mag_damage(GET_LEVEL(ch), ch, tch, spellnum, 1);
      break;

    case SPELL_CHAIN_LIGHTNING:
      mag_damage(GET_LEVEL(ch), ch, tch, spellnum, 1);
      break;

    case SPELL_CLOUDKILL:
      mag_affects(GET_LEVEL(ch), ch, tch, spellnum, 1);
      mag_damage(GET_LEVEL(ch), ch, tch, spellnum, 1);
      break;

    case SPELL_CONE_OF_COLD:
      mag_damage(GET_LEVEL(ch), ch, tch, spellnum, 1);
      break;

    case SPELL_EARTHQUAKE:
      mag_damage(GET_LEVEL(ch), ch, tch, spellnum, 1);
      break;

    case SPELL_FIREBALL:
      mag_damage(GET_LEVEL(ch), ch, tch, spellnum, 1);
      break;

    case SPELL_FIRESTORM:
      mag_damage(GET_LEVEL(ch), ch, tch, spellnum, 1);
      break;

    case SPELL_ICE_STORM:
      mag_damage(GET_LEVEL(ch), ch, tch, spellnum, 1);
      break;

    case SPELL_NUKE:
      mag_damage(GET_LEVEL(ch), ch, tch, spellnum, 1);
      break;

    case SPELL_SUNRAY:
      mag_damage(GET_LEVEL(ch), ch, tch, spellnum, 1);
      break;

    case SKILL_BASH:
      if (savetype == SAVING_NO_SAVE)
        do_bash(ch, GET_NAME(tch), 0, SCMD_BASH_NO_SAVE);
      else
        do_bash(ch, GET_NAME(tch), 0, 0);
      break;

    case SKILL_TRIP:
      if (savetype == SAVING_NO_SAVE)
        do_trip(ch, GET_NAME(tch), 0, SCMD_TRIP_NO_SAVE);
      else
        do_trip(ch, GET_NAME(tch), 0, 0);
      break;

    case SKILL_BERSERK:
      /* hit(ch, tch, SKILL_BERSERK); */
      mag_damage(GET_LEVEL(ch), ch, tch, spellnum, SAVING_NO_SAVE);
      break;

    default:
      return;
    }
  
  }

}


/*
  Every spell which summons/gates/conjours a mob comes through here.
*/

static char *mag_summon_msgs[] = {
  "\r\n",
  "$n animates a corpse!\r\n",
  "$n makes a strange magical gesture; you feel a strong breeze!\r\n",
  "$N appears from a cloud of thick blue smoke!\r\n",
  "$N appears from a cloud of thick green smoke!\r\n",
  "$N appears from a cloud of thick red smoke!\r\n",
  "$N disappears in a thick black cloud!\r\n",
  "As $n makes a strange magical gesture, you feel a strong breeze.\r\n",
  "As $n makes a strange magical gesture, you feel a searing heat.\r\n",
  "As $n makes a strange magical gesture, you feel a sudden chill.\r\n",
  "As $n makes a strange magical gesture, you feel the dust swirl.\r\n",
  "$n magically divides!\r\n",
  "$N hops out from behind a rock and croaks to $n.\r\n",
  "$N flaps its wings and settles on $n's arm.\r\n",
  "$N comes running to $n and meows.\r\n",
  "$N glides quietly to $n's arm.\r\n",
  "$N peeps out from behind a rock and comes scurrying to $n.\r\n",
  "$N slithers to $n's side.\r\n",
  "$N forms in a swirl and a buzz and holds in a mass at $n's command.\r\n"
};

static char *mag_summon_fail_msgs[] = {
  "\r\n",
  "There is no corpse!\r\n",
  "There are no such creatures.\r\n",
  "Uh oh...\r\n",
  "Oh dear.\r\n",
  "Oh shit!\r\n",
  "The elements resist!\r\n",
  "You failed.\r\n",
  "A familiar animal is too afraid of your followers to come!\r\n",
  "Not even a gnat comes to your bidding.\r\n"
};

#define MOB_UNDEAD_BASE		100
#define NUMBER_UNDEAD		6
#define MOB_ELEMENTAL_BASE	110
#define NUMBER_ELEMENTAL	4
#define MOB_AERIAL_SERVANT	120
#define MOB_STICKS_TO_SNAKES	121
#define MOB_PHANTASMAL_FORCE	122
#define MOB_MONSUM_I		130
#define MOB_MONSUM_II		131
#define MOB_MONSUM_III		132
#define MOB_GATE_I		140
#define MOB_GATE_II		141
#define MOB_GATE_III		142
#define MOB_CLONE		150
#define MOB_INSECT_PLAGUE	160
#define MOB_INVISIBLE_STALKER	170
#define MOB_FAMILIAR_BASE	180
#define NUMBER_FAMILIAR		6



void mag_summons(int level, struct char_data * ch, struct obj_data * obj,
		      int spellnum, int savetype)
{
  struct char_data *mob;
  struct obj_data *tobj, *next_obj;
  int pfail = 0;
  int msg = 0, fmsg = 0;
  int num = 1;
  int a, i;
  int mob_num = 0;
  int handle_corpse = 0;
  struct follow_type *f;
  int num_followers = 0;

  extern int cha_max_followers[26];

  if (ch == NULL)
    return;

  switch (spellnum) {
    case SPELL_AERIAL_SERVANT:
      msg = 2;
      fmsg = 7;
      mob_num = MOB_AERIAL_SERVANT;
      pfail = 8;
      break;

    case SPELL_AIR_ELEMENTAL:
      mob_num = 127;
      pfail = 8;
      msg = 3;
      fmsg = 3;
      break;

    case SPELL_ANIMATE_DEAD:
      if ((obj == NULL) || (GET_OBJ_TYPE(obj) != ITEM_CONTAINER) ||
        (!GET_OBJ_VAL(obj, 3)) || (GET_OBJ_VAL(obj, 2) == -2) /* pcorpse */) {
        act(mag_summon_fail_msgs[1], FALSE, ch, 0, 0, TO_CHAR);
        return;
      }
      /* use a corpse as the component of the spell */
      handle_corpse = 1;
      msg = 1;

      /* determine which undead actually gets summoned */
      /* sometime in the future, make this dependent on the level of caster */
      /* a = adjustment to the level of summoned mob */
      a = MAX(0, ((GET_LEVEL(ch) - 10)/ NUMBER_UNDEAD) - 2 + dice(2,2));
      a = MIN(a, NUMBER_UNDEAD - 1);
      a = number(0, a);
      mob_num = MOB_UNDEAD_BASE + a;

      /* the percent failure is a flat 8% */
      pfail = 8;
      break;

    case SPELL_CLONE:
      mob_num = MOB_CLONE;
      pfail = 8;
      msg = 11;
      fmsg = 7;
      break;

    case SPELL_CONJURE_ELEMENTAL:
      mob_num = MOB_ELEMENTAL_BASE + number(0, NUMBER_ELEMENTAL -1);
      pfail = 8;
      msg = 7 + mob_num - MOB_ELEMENTAL_BASE;
      fmsg = 6;
      break;

    case SPELL_EARTH_ELEMENTAL:
      mob_num = 125;
      pfail = 8;
      msg = 3;
      fmsg = 3;
      break;

    case SPELL_FIND_FAMILIAR:
      mob_num = MOB_FAMILIAR_BASE + number(0, NUMBER_FAMILIAR -1);
      if (ch->followers)
        pfail = 102;
      else
        pfail = 8;
      msg = 12 + mob_num - MOB_FAMILIAR_BASE;
      if (ch->followers)
        fmsg = 8;
      else
        fmsg = 7;
      break;

    case SPELL_FIRE_ELEMENTAL:
      mob_num = 128;
      pfail = 8;
      msg = 3;
      fmsg = 3;
      break;

    case SPELL_GATE_I:
      mob_num = MOB_GATE_I;
      pfail = 8;
      msg = 3;
      fmsg = 3;
      break;

    case SPELL_GATE_II:
      mob_num = MOB_GATE_II;
      pfail = 8;
      msg = 4;
      fmsg = 4;
      break;

    case SPELL_GATE_III:
      mob_num = MOB_GATE_III;
      pfail = 8;
      msg = 5;
      fmsg = 5;
      break;

    case SPELL_INSECT_PLAGUE:
      msg = 18;
      fmsg = 9;
      mob_num = MOB_INSECT_PLAGUE;
      pfail = 8;
      break;

    case SPELL_INVISIBLE_STALKER:
      mob_num = MOB_INVISIBLE_STALKER;
      pfail = 8;
      msg = 2;
      fmsg = 2;
      break;

    case SPELL_MONSUM_I:
      mob_num = MOB_MONSUM_I;
      pfail = 8;
      msg = 2;
      fmsg = 2;
      break;

    case SPELL_MONSUM_II:
      mob_num = MOB_MONSUM_II;
      pfail = 8;
      msg = 2;
      fmsg = 2;
      break;

    case SPELL_MONSUM_III:
      mob_num = MOB_MONSUM_III;
      pfail = 8;
      msg = 2;
      fmsg = 2;
      break;

    case SPELL_PHANTASMAL_FORCE:
      msg = 4;
      fmsg = 7;
      mob_num = MOB_PHANTASMAL_FORCE;
      pfail = 8;
      break;

    case SPELL_STICKS_TO_SNAKES:
      msg = 17;
      fmsg = 6;
      mob_num = MOB_STICKS_TO_SNAKES;
      pfail = 8;
      break;

    case SPELL_WATER_ELEMENTAL:
      mob_num = 126;
      pfail = 8;
      msg = 3;
      fmsg = 3;
      break;

    default:
      return;
  }

  if (IS_AFFECTED(ch, AFF_CHARM)) {
    send_to_char("You are too giddy to have any followers!\r\n", ch);
    return;
  }

  for (f = ch->followers; f; f = f->next) {
    if (IS_NPC(f->follower))
      num_followers++;
  }

  if (num_followers >= cha_max_followers[GET_CHA(ch)]) {
    pfail = 102;
    fmsg = 4;
  }

  if (number(0, 101) < pfail) {
    send_to_char(mag_summon_fail_msgs[fmsg], ch);
    switch (spellnum) {
      case SPELL_GATE_I:
      case SPELL_GATE_II:
      case SPELL_GATE_III:
        /* the demon is summoned, only it attacks instead of doing the
           caster's bidding! */
        mob = read_mobile(mob_num, VIRTUAL);
        char_to_room(mob, ch->in_room);

        IS_CARRYING_W(mob) = 0;
        IS_CARRYING_N(mob) = 0;

        set_fighting(mob, ch);
        break;
      default:
        mob = read_mobile(mob_num, VIRTUAL);
        char_to_room(mob, ch->in_room);

        IS_CARRYING_W(mob) = 0;
        IS_CARRYING_N(mob) = 0;

        set_fighting(mob, ch);
        break;
    }
    return;
  }
  for (i = 0; i < num; i++) {
    mob = read_mobile(mob_num, VIRTUAL);
    char_to_room(mob, ch->in_room);

    IS_CARRYING_W(mob) = 0;
    IS_CARRYING_N(mob) = 0;

    if (spellnum != SPELL_FIND_FAMILIAR)
      SET_BIT(AFF_FLAGS(mob), AFF_CHARM);
    if (spellnum == SPELL_CLONE) {
      strcpy(GET_NAME(mob), GET_NAME(ch));
      sprintf(buf, "a clone of %s", GET_NAME(ch));
      strcpy(mob->player.short_descr, buf);
      sprintf(buf, "A clone of %s is here, a mere husk of a living thing.\r\n",
              GET_NAME(ch));
      strcpy(mob->player.long_descr, buf);
    }
    add_follower(mob, ch);
    act(mag_summon_msgs[msg], FALSE, ch, 0, mob, TO_ROOM);
    if (spellnum == SPELL_FIND_FAMILIAR) {
      act("You see through the eyes of $N.", FALSE, ch, 0, mob, TO_CHAR);
      send_to_char("Type return to go back to your body.\r\n", ch);
      ch->desc->character = mob;
      ch->desc->original = ch;
      mob->desc = ch->desc;
      ch->desc = NULL;
/* Fix for familiars casting spells */
      SET_BIT(AFF2_FLAGS(mob), AFF2_JARRED);
    }
  }
  if (handle_corpse) {
    for (tobj = obj->contains; tobj; tobj = next_obj) {
      next_obj = tobj->next_content;
      obj_from_obj(tobj);
      obj_to_char(tobj, mob);
    }
    extract_obj(obj);
  }
}



void mag_points(int level, struct char_data * ch, struct char_data * victim,
		     int spellnum, int savetype)
{
  int hit = 0;
  int expgain = 0;
  int mana = 0;
  int move = 0;

  if (victim == NULL)
    return;

  switch (spellnum) {

  case SPELL_CURE_CRITIC:
    hit = dice(7, 8) + 8 + (level);
    send_to_char("You feel a lot better!\r\n", victim);
    if(!IS_NPC(victim) && ch != victim
		&& GET_POS(victim) == POS_FIGHTING
		&& GET_HIT(victim) < GET_MAX_HIT(victim)) {
	expgain = MIN(GET_MAX_HIT(victim) - GET_HIT(victim), hit);
	gain_exp(ch, expgain);
    }
    break;

  case SPELL_CURE_LIGHT:
    hit = dice(2, 8) + 1 + (level >> 2);
    send_to_char("You feel better.\r\n", victim);
    if(!IS_NPC(victim) && ch != victim
		&& GET_POS(victim) == POS_FIGHTING
		&& GET_HIT(victim) < GET_MAX_HIT(victim)) {
	expgain = MIN(GET_MAX_HIT(victim) - GET_HIT(victim), hit);
	gain_exp(ch, expgain);
    }
    break;

  case SPELL_CURE_SERIOUS:
    hit = dice(3, 8) + 5 + (level > 2);
    send_to_char("You feel much better.\r\n", victim);
    if(!IS_NPC(victim) && ch != victim
		&& GET_POS(victim) == POS_FIGHTING
		&& GET_HIT(victim) < GET_MAX_HIT(victim)) {
	expgain = MIN(GET_MAX_HIT(victim) - GET_HIT(victim), hit);
	gain_exp(ch, expgain);
    }
    break;

  case SPELL_FEEBLEMIND:
    if (mag_savingthrow(victim, savetype)) {
      send_to_char("You sense that your victim is as lucid as ever.\r\n", ch);
      return;
    }
    mana -= dice(3, 8) + 3 + (level >> 2);
    send_to_char("You feel so stupid!\r\n", victim);
    break;
 
  case SPELL_HEAL:
    act("$n looks much better.", TRUE, victim, 0, 0, TO_ROOM);
    if (IS_CHAOS_ROOM(ch->in_room)) {
      hit = 100 + GET_LEVEL(ch);
      send_to_char("A warm feeling floods your body.\r\n", victim);
    } else {
      hit = 100 + (GET_WIS(ch) * 3) + GET_LEVEL(ch);
      send_to_char("A warm feeling floods your body.\r\n", victim);
    }
    if(!IS_NPC(victim) && ch != victim
		&& GET_POS(victim) == POS_FIGHTING
		&& GET_HIT(victim) < GET_MAX_HIT(victim)) {
	expgain = MIN(GET_MAX_HIT(victim) - GET_HIT(victim), hit);
	gain_exp(ch, expgain);
    }
    break;

  case SPELL_ENERGY_FLUX:
    act("$n looks energized.", TRUE, victim, 0, 0, TO_ROOM);
    mana = 80 + (GET_INT(ch) * 3) + GET_LEVEL(ch);
    send_to_char("A surge of energy floods your body.\r\n", victim);
    break;

  case SPELL_WILD_HEAL:
    switch (number(0, 16)) {
      case 0:
        /*hit = -75; */
	damage(victim, victim, 75, SPELL_POISON);
        send_to_char("You are surrounded by a black mist.\r\n", ch);
        act("$n is surrounded by a black mist.\r\n",
        TRUE, victim, NULL, NULL, TO_ROOM);
        break;
      case 1:
      case 2:
        /* hit = -25; */
	damage(victim, victim, 25, SPELL_POISON);
        send_to_char("You are surrounded by a red mist.\r\n", ch);
        act("$n is surrounded by a red mist.\r\n",
        TRUE, victim, NULL, NULL, TO_ROOM);
        break;
      case 3:
      case 4:
      case 5:
      case 6:
      case 7:
      case 8:
      case 9:
      case 10:
      case 11:
      case 12:
      case 13:
        hit = 150;
        send_to_char("You are surrounded by a blue mist.\r\n", ch);
        act("$n is surrounded by a blue mist.\r\n",
        TRUE, victim, NULL, NULL, TO_ROOM);
	if(!IS_NPC(victim) && ch != victim
		&& GET_POS(victim) == POS_FIGHTING
		&& GET_HIT(victim) < GET_MAX_HIT(victim)) {
	    expgain = MIN(GET_MAX_HIT(victim) - GET_HIT(victim), hit);
	    gain_exp(ch, expgain);
	}
        break;
      case 14:
      case 15:
        hit = 175;
        send_to_char("You are surrounded by a white mist.\r\n", ch);
        act("$n is surrounded by a white mist.\r\n",
        TRUE, victim, NULL, NULL, TO_ROOM);
	if(!IS_NPC(victim) && ch != victim
		&& GET_POS(victim) == POS_FIGHTING
		&& GET_HIT(victim) < GET_MAX_HIT(victim)) {
	    expgain = MIN(GET_MAX_HIT(victim) - GET_HIT(victim), hit);
	    gain_exp(ch, expgain);
	}
        break;
      case 16:
        hit = 200;
        send_to_char("You are surrounded by a yellow mist.\r\n", ch);
        act("$n is surrounded by a yellow mist.\r\n",
        TRUE, victim, NULL, NULL, TO_ROOM);
	if(!IS_NPC(victim) && ch != victim
		&& GET_POS(victim) == POS_FIGHTING
		&& GET_HIT(victim) < GET_MAX_HIT(victim)) {
	    expgain = MIN(GET_MAX_HIT(victim) - GET_HIT(victim), hit);
	    gain_exp(ch, expgain);
	}
        break;
      default:
        hit = 150;
        break;
    }
  break;

  case SPELL_REFRESH:
    move = (GET_LEVEL(ch) / 2) + number(2, 18);
    send_to_char("You feel refreshed!\r\n", victim);
    break;

  case SPELL_RESTORE:
    act("You lay your hands on $N and mend $S wounds.", FALSE, ch, 0, victim, TO_CHAR);
    hit = 1500;
    send_to_char("A vibrant feeling floods your body!!!\r\n", victim);
    if(!IS_NPC(victim) && ch != victim
		&& GET_POS(victim) == POS_FIGHTING
		&& GET_HIT(victim) < GET_MAX_HIT(victim)) {
	expgain = MIN(GET_MAX_HIT(victim) - GET_HIT(victim), hit);
	gain_exp(ch, expgain);
    }
    break;

#if 0
  case SPELL_WEB:
    if (mag_savingthrow(victim, savetype)) {
      send_to_char("You almost got snagged by webbing!\r\n", victim);
      act("$n almost got snagged by webbing!\r\n",
        TRUE, victim, NULL, NULL, TO_ROOM);
      return;
    }
    move = - (dice(10, 10) + GET_LEVEL(ch));
    send_to_char("Sticky webs hinder your movement!\r\n", victim);
    act("$n is covered with webs, hindering $s movement!\r\n",
        TRUE, victim, NULL, NULL, TO_ROOM);
    if (!mag_savingthrow(victim, savetype)) {
      send_to_char("You struggle in the webbing!\r\n", victim);
      act("$n struggles in the webbing!\r\n",
        TRUE, victim, NULL, NULL, TO_ROOM);
    } else {
      move /= 2;
    }
    break;
#endif

  } /* end of case */

  GET_HIT(victim) = MIN(GET_MAX_HIT(victim), GET_HIT(victim) + hit);
  if (mana < 0)
    GET_MANA(victim) = MAX(0, GET_MANA(victim) + mana);
  else
    GET_MANA(victim) = MIN(GET_MAX_MANA(victim), GET_MANA(victim) + mana);
  if (move < 0)
    GET_MOVE(victim) = MAX(0, GET_MOVE(victim) + move);
  else
    GET_MOVE(victim) = MIN(GET_MAX_MOVE(victim), GET_MOVE(victim) + move);
}



void mag_unaffects(int level, struct char_data * ch, struct char_data * victim,
		        int spellnum, int type)
{
  int spell = 0;
  char *to_vict = NULL, *to_room = NULL;

  if (victim == NULL)
    return;

  switch (spellnum) {

  case SPELL_CURE_BLIND:
    spell = SPELL_BLINDNESS;
    to_vict = "Your vision returns!";
    break;

  case SPELL_MIRROR_IMAGE:
    spell = SPELL_MIRROR_IMAGE;
    GET_IMAGES(ch) = 0;
    break;

  case SPELL_REMOVE_POISON:
    spell = SPELL_POISON;
    to_vict = "A warm feeling runs through your body as the vile poisons are purged!";
    to_room = "$n looks better.";
    break;

  case SPELL_DISPEL_SANCTUARY:
    spell = SPELL_SANCTUARY;
    to_vict = "Your aura flickers and dies!";
    to_room = "$n suddenly stops glowing!";
    break;

  case SPELL_STONESKIN:
    spell = SPELL_STONESKIN;
    break;

  case SPELL_REMOVE_CURSE:
    spell = SPELL_CURSE;
    to_vict = "You feel the curse's grip release you.";
    break;

  case SPELL_FAERIE_FOG:
    spell = SPELL_INVISIBLE;
    to_vict = "You are revealed!";
    to_room = "$n is revealed!";
    break;

  default:
    sprintf(buf, "SYSERR: unknown spellnum %d passed to mag_unaffects", spellnum);
    log(buf);
    return;
    break;

  }

  if (affected_by_spell(victim, spell)) {
    affect_from_char(victim, spell);
    if (to_vict != NULL) {
      send_to_char(to_vict, victim);
      send_to_char("\r\n", victim);
    }
    if (to_room != NULL)
      act(to_room, TRUE, victim, NULL, NULL, TO_ROOM);
  } else if (to_vict != NULL)
    send_to_char("Nothing seems to happen.\r\n", ch);
}



void mag_alter_objs(int level, struct char_data * ch, struct obj_data * obj,
		         int spellnum, int savetype)
{
  char *to_char = NULL;

  if (obj == NULL)
    return;

  switch (spellnum) {

    case SPELL_INVISIBLE:
      if (!IS_OBJ_STAT(obj, ITEM_NOINVIS | ITEM_INVISIBLE)) {
        SET_BIT(obj->obj_flags.extra_flags, ITEM_INVISIBLE);
        to_char = "$p turns invisible.";
      }
      break;

    case SPELL_REMOVE_CURSE:
      if (IS_OBJ_STAT(obj, ITEM_NODROP)) {
        REMOVE_BIT(obj->obj_flags.extra_flags, ITEM_NODROP);
        to_char = "$p briefly glows blue.";
      }
      break;

  }

  if (to_char == NULL)
    send_to_char("Nothing seems to happen.\r\n", ch);
  else
    act(to_char, TRUE, ch, obj, 0, TO_CHAR);
}



void mag_objects(int level, struct char_data * ch, struct obj_data * obj,
		      int spellnum)
{
  switch (spellnum) {
    case SPELL_CREATE_WATER:
    break;
  }
}



#define CREATE_IN_INVENTORY	0
#define CREATE_ON_GROUND	1
void mag_creations(int level, struct char_data * ch, int spellnum)
{
  struct obj_data *tobj;
  int z;
  int to = CREATE_IN_INVENTORY;   /* default */


  if (ch == NULL)
    return;
  level = MAX(MIN(level, LVL_IMPL), 1);

  switch (spellnum) {

  case SPELL_CREATE_FOOD:
    z = 7090;
    break;

  case SPELL_CONTINUAL_LIGHT:
    z = 140;
    break;

  case SPELL_CREATE_SPRING:
    z = 150;
    to = CREATE_ON_GROUND;
    break;

  case SPELL_CREATE_BLOOD:
    z = 151;
    to = CREATE_ON_GROUND;
    break;

  case SPELL_SPIRITUAL_HAMMER:
    z = 152;
    break;

  default:
    send_to_char("Spell unimplemented, it would seem.\r\n", ch);
    return;
    break;
  }

  if (!(tobj = read_object(z, VIRTUAL))) {
    send_to_char("I seem to have goofed.\r\n", ch);
    sprintf(buf, "SYSERR: spell_creations, spell %d, obj %d: obj not found",
	    spellnum, z);
    log(buf);
    return;
  }

  switch (to) {
    case CREATE_ON_GROUND:
        obj_to_room(tobj, ch->in_room);
        break;
    case CREATE_IN_INVENTORY:
    default:
        obj_to_char(tobj, ch);
        break;
  }
  act("$n creates $p.", FALSE, ch, tobj, 0, TO_ROOM);
  act("You create $p.", FALSE, ch, tobj, 0, TO_CHAR);
}
